---
import Layout from '../layouts/Layout.astro';
import RequireAuth from '../components/RequireAuth.astro';
---

<Layout>
  <RequireAuth>
    <main class="min-h-screen p-6">
      <div class="max-w-4xl mx-auto">
        <h1 class="text-2xl font-semibold">Mis Recolecciones</h1>
        <div id="empty" class="mt-4 text-gray-600">Cargando solicitudes...</div>
        <ul id="list" class="mt-4 space-y-3"></ul>
      </div>
    </main>

    <script type="module">
      const listEl = document.getElementById('list');
      const emptyEl = document.getElementById('empty');
      const userEmail = localStorage.getItem('userEmail') || 'guest';
      const key = `collections_${userEmail}`;

      function render() {
        listEl.innerHTML = '';
        let items = [];
        try{
          const raw = localStorage.getItem(key);
          if(raw) items = JSON.parse(raw);
        } catch(err) { items = []; }

        if(!items || items.length === 0){
          emptyEl.textContent = 'No tienes solicitudes de recolección.';
          return;
        }

        emptyEl.textContent = '';

        items.forEach(item => {
          const li = document.createElement('li');
          li.className = 'border border-gray-200 rounded p-3';
          li.innerHTML = `
            <div class="flex justify-between items-start">
              <div>
                <div class="font-semibold">${item.wasteType} — ${item.locality}</div>
                <div class="text-sm text-gray-600">${item.address}</div>
                <div class="text-xs text-gray-500 mt-1">Solicitado: ${new Date(item.requestDate).toLocaleString()}</div>
                <div class="text-xs text-gray-500">Estado: ${item.status}</div>
              </div>
              <div class="flex flex-col items-end space-y-2">
                <button data-id="${item.id}" class="del btn bg-red-600 text-white px-3 py-1 rounded text-sm">Eliminar</button>
              </div>
            </div>
          `;

          listEl.appendChild(li);
        });

        // attach events
        listEl.querySelectorAll('.del').forEach(b => b.addEventListener('click', (e)=>{
          const id = Number(e.currentTarget.dataset.id);
          let items = JSON.parse(localStorage.getItem(key) || '[]');
          items = items.filter(i => i.id !== id);
          localStorage.setItem(key, JSON.stringify(items));
          render();
        }));

        listEl.querySelectorAll('.mark').forEach(b => b.addEventListener('click', async (e)=>{
          const id = Number(e.currentTarget.dataset.id);
          let items = JSON.parse(localStorage.getItem(key) || '[]');
          const idx = items.findIndex(i=> i.id === id);
          if(idx === -1) return;

          // pedir peso y fecha de recolección
          const peso = prompt('Ingrese el peso recolectado (kg)');
          if(peso === null) return; // cancel
          const fecha = new Date().toISOString();
          items[idx].estado = 'recogido';
          items[idx].peso = peso;
          items[idx].fechaRecoleccion = fecha;
          items[idx].turno = items[idx].turno || 'mañana';
          localStorage.setItem(key, JSON.stringify(items));
          render();
        }));
      }

      render();
    </script>
  </RequireAuth>
</Layout>
