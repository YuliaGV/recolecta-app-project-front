---
import DashboardLayout from "../layouts/DashboardLayout.astro";
---

<DashboardLayout>
  <h1 class="text-3xl font-bold mb-6 text-gray-800">
    Solicitar Nueva Recolección
  </h1>

  <form id="newCollectionForm" class="space-y-6">
    <fieldset class="border border-gray-300 p-4 rounded-md">
      <legend class="text-lg font-semibold text-gray-700"
        >Tipo de Residuo</legend
      >
      <div class="flex items-center space-x-6 mt-2">
        <label class="flex items-center">
          <input
            type="radio"
            name="wasteType"
            value="inorganico"
            required
            class="text-green-600 focus:ring-green-500"
            checked
          />
          <span class="ml-2 text-gray-600">Inorgánico Reciclable</span>
        </label>
        <label class="flex items-center">
          <input
            type="radio"
            name="wasteType"
            value="peligroso"
            required
            class="text-red-600 focus:ring-red-500"
          />
          <span class="ml-2 text-gray-600">Peligroso (Especial)</span>
        </label>
      </div>
    </fieldset>

    <div>
      <label for="address" class="block text-sm font-medium text-gray-700"
        >Dirección</label
      >
      <input
        id="address"
        name="address"
        required
        class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 focus:ring-2 focus:ring-blue-400"
      />
    </div>

    <div>
      <label for="locality" class="block text-sm font-medium text-gray-700"
        >Localidad</label
      >
      <select
        id="locality"
        name="locality"
        required
        class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 focus:ring-2 focus:ring-blue-400"
      >
        <option value="">Selecciona una localidad</option>
        <option>Suba</option>
        <option>Chapinero</option>
        <option>Engativá</option>
        <option>Bosa</option>
        <option>Usaquén</option>
        <option>Fontibón</option>
      </select>
    </div>

    <button
      type="submit"
      class="w-full py-2 px-4 rounded-md text-white font-semibold transition-colors bg-green-600 hover:bg-green-700"
    >
      Confirmar Solicitud de Recolección
    </button>
  </form>

  <div id="message" class="mt-4 hidden p-3 rounded-md"></div>

  <script type="module">
    const form = document.getElementById("newCollectionForm");
    const msg = document.getElementById("message");

    function showMessage(text, type = "success") {
      msg.classList.remove("hidden");
      msg.textContent = text;
      if (type === "success") {
        msg.className =
          "mt-4 p-3 rounded-md bg-green-50 text-green-800 border border-green-200";
      } else {
        msg.className =
          "mt-4 p-3 rounded-md bg-red-50 text-red-800 border border-red-200";
      }
    }

    form.addEventListener("submit", (e) => {
      e.preventDefault();
      const data = new FormData(form);
      const wasteType = (data.get("wasteType") || "").toString();
      const address = (data.get("address") || "").toString().trim();
      const locality = (data.get("locality") || "").toString();

      if (!wasteType || !address || !locality) {
        showMessage("Por favor completa todos los campos.", "error");
        return;
      }

      const userEmail = localStorage.getItem("userEmail") || "guest";

      const newReq = {
        id: Date.now(),
        userEmail,
        wasteType,
        address,
        locality,
        requestDate: new Date().toISOString(),
        status: "Asignación pendiente",
        shift: null,
        collectionDate: null,
        weight: null,
      };

      const key = `collections_${userEmail}`;
      let list = [];
      try {
        const raw = localStorage.getItem(key);
        if (raw) list = JSON.parse(raw);
      } catch {}

      list.unshift(newReq);
      try {
        localStorage.setItem(key, JSON.stringify(list));
      } catch {
        showMessage(
          "No se pudo guardar la solicitud en localStorage.",
          "error"
        );
        return;
      }

      showMessage(
        "Solicitud creada correctamente. Redirigiendo a Mis Recolecciones..."
      );
      location.replace("/my-collections");
    });
  </script>
</DashboardLayout>
